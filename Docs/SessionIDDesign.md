# セッションID設計指針 / Session ID Design Guide

データセッションIDを人間が読んでも状況が把握しやすくし、オフライン保存とクラウド同期が混在する状況でも衝突や誤上書きを防ぐための設計案です。iOS端末内で生成・編集されるCSVのライフサイクルを意識したフィールド運用向けの指針としてまとめています。

## 1. 目的 / Goals
- **トレーサビリティ向上**: どの端末がいつどこで作成/編集したデータかを一目で把握。
- **衝突回避**: オフライン保存→後でクラウド反映する際に、既存セッションとの衝突や重複を減らす。
- **編集履歴の可視化**: 複製/上書き/マージなどの編集操作を判別しやすくする。
- **デバッグ容易性**: 異常報告時にIDを見るだけで「発生環境」「タイムライン」「編集段階」を推測できる。

## 2. 推奨フォーマット / Recommended Format
```
<Op>-<ISO8601>-<DeviceID>-<Context>-<Rand>-v<Rev>-<Sync>
例) MEASURE-2024-06-05T14:23:10+09:00-iP12A-TSUKUBA-7K3P9-v1-OFF
```
- **Op (操作種別)**: `MEASURE`, `EDIT`, `DUP`, `MERGE` など。履歴一覧で現象を判別しやすくする。
- **ISO8601**: 生成時刻（タイムゾーン込み）で時系列が即座にわかる。
- **DeviceID**: 端末略号（例: `iP12A`）やログインユーザー略号を付与し、どの端末由来か特定。
- **Context**: サーキット/車両/計測モードなどの短い略号。任意長だが3–10文字に収めると一覧性が良い。
- **Rand**: 4–6桁の英数字ランダム。並行測定や同時編集での衝突を避ける。
- **v<Rev> (版数)**: `v1` から開始し、編集ごとに `+1`。複製なら `v1` で新IDを起こし、上書きなら同IDで版数のみ更新。
- **Sync (同期状態)**: `OFF`=ローカルのみ、`ON`=クラウド反映済み、`MERGED`=クラウドとマージ済み。UIにそのまま表示すると混乱が減る。

## 3. オフライン運用と同期 / Offline & Sync Flow
1. **生成**: オフラインでも上記フォーマットでID生成。`Sync=OFF` として保存。
2. **編集**: オフライン編集時は同一IDで `v` を+1。クラウド未反映のまま履歴に残す。
3. **同期**:
   - アップロード時にクラウドが同一IDを保持していれば **サーバ側で版数比較**→新しい方を採用、差分をログ。
   - ローカルのみ存在する場合は新規作成し、`Sync=ON` に更新。
   - サーバ版とローカル版が双方進んでいる場合は `MERGE-...` の新IDを払い出し、元IDを `MERGED` 状態に変更しリンクを保持する。
4. **複製**: 過去データをテンプレート利用する場合は `DUP-<元ID>` を `Context` またはメタフィールドに記録し、新IDを `v1` で生成。
5. **上書き防止UI**: 「閲覧のみの過去セッション」と「編集中の現セッション」を明示し、保存時に **現ID** と **対象ID** をダイアログに表示。

## 4. CSVフィールド例 / CSV Field Suggestions
- `session_id`: 上記フォーマット全文。
- `op_type`: `MEASURE | EDIT | DUP | MERGE`。
- `device_id`: 端末略号またはUUID下位。
- `context`: サーキット/車両/モード等。
- `revision`: 数値のみ（例: `1`, `2`）。
- `sync_state`: `OFF | ON | MERGED`。
- `parent_session_id`: 複製やマージ時の元ID（無ければ空）。
- `last_synced_at`: `YYYY-MM-DDTHH:mm:ssZ`。
- `notes`: ユーザーが自由記述。調査用に活用。

## 5. デバッグ/運用Tips / Debug & Ops Tips
- **履歴一覧のカラム例**: `Op | SessionID | v | Sync | Device | Context | Created | Updated | Parent`。
- **フィルタ**: `Sync=OFF` だけを抽出し「要アップロード」ビューにまとめる。衝突や未送信を即発見。
- **差分プレビュー**: 保存前に `parent_session_id` と比較し、変更行数を UI に表示。上書きか複製かを意識させる。
- **ロギング**: `sourceSessionId` / `targetSessionId` を操作ログに必ず残す。版数を含めておくと調査が早い。

## 6. 実装時のポイント / Implementation Hints
- **ID生成は純粋関数**にし、テストで固定日時・固定ランダムを差し込めるようにする。
- **タイムゾーンを必ず保持**: フィールドではUTCと現地時間が混在しやすい。ISO8601（例: `+09:00`）で一意に。
- **CSV/メタ構造体に `syncState` と `revision` を必須項目として追加**: UI での判別とクラウドマージに利用。
- **衝突判定**: クラウド側で `session_id` が一致し、`revision` が同一の場合のみ上書き。異なる場合は `MERGE` フローへ。
- **ランダム部の長さ**: 5桁なら10進で約10万通り。併せて端末IDと時刻が入るため実用上は十分。

このフォーマットと運用ルールを採用することで、オフライン→クラウド同期→他端末編集といった複雑な経路でも「どこで複製されたのか」「どの版が正しいのか」を素早く判定でき、デバッグや問い合わせ対応が容易になります。

## 7. 実装状況 / Implementation Status Snapshot
- `SessionViewModel` で新フォーマットのIDを払い出し、旧UUIDは自動でラップ（後方互換）。
- CSV/Drive 送信・履歴一覧は新IDで検索/ソート可能。パス生成時は `safeFileToken()` で無害化。
- 追加タスク（例: `v`増分のUI連動、Sync状態更新、重複検知）は `Docs/SessionIDImpact.md` に記載。
