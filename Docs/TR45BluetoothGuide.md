# TR45 Bluetooth 接続マニュアル / TR45 Bluetooth Integration Guide

このドキュメントはTR45温度ロガーをBluetoothで利用するための実践的な手順・ノウハウをまとめたものです。初期セットアップから運用時の注意点、アプリ側で必要となる設定項目や改善案までを網羅し、引き継ぎメンバーが最短で立ち上がれるようにすることを目的としています。

## 目的 / Purpose
- TR45をBluetooth経由で安定接続し、確実に温度データを取得できる状態を作る。
- 現場でのつまずきポイント（セキュリティモード、サンプリング周波数、登録コード入力など）を事前に解消する。
- 将来的な改善点を共有し、運用負荷を下げながらデータ品質を高める。

## 事前準備 / Prerequisites
- TR45 本体（裏面または付属箱に登録コードが貼付されていることを確認）。
- iOS/iPadOS アプリ（PitTemp）をデバッグ・ビルドできる環境。
- Bluetooth 権限が許可された状態の端末。
- 現場で電波干渉が少ない環境（可能であれば5m以内でセットアップ）。

## 接続の基本フロー / Basic Connection Flow
1. **電源投入・リセット**: TR45 の電源を入れ、必要に応じてリセットを実施（過去接続情報による競合を避ける）。
2. **スキャン開始**: アプリからBluetoothスキャンを開始し、TR45 がアドバタイズされることを確認。
3. **ペアリング要求**: TR45 を選択して接続要求を送信。セキュリティモードがOnの場合は登録コードが必要。
4. **サービス探索**: GATTサービスを列挙し、温度計測用キャラクタリスティックにサブスクライブ。
5. **初回設定**: サンプリング周波数やセキュリティモードなどの設定値を確認・書き込み。
6. **データ受信**: 通知を受け取り、温度データをアプリのデータモデルへ保存。

## セキュリティモードと登録コード / Security Mode & Registration Code
- **Security On** にするとペアリング時に **登録コード（ペアリングコード）** の入力が必須。コードは本体裏面・購入時の箱・付属ドキュメントを確認。
- アプリ側では以下のUI/UXを提供する:
  - TR45選択直後に登録コード入力ダイアログを表示（再入力できるよう履歴をプレフィル）。
  - 入力値はKeychainに安全に保存し、自動再接続時に自動送信する。
  - 入力ミス検知のため、3回連続失敗時は再スキャンを促すガイダンスを表示。
- 実装観点:
  - BLE接続時に`CBPeripheral`の`didWriteValueFor`エラーを監視し、`insufficient authentication`が返ったらダイアログを再提示。
  - コード送信は同期的に1キャラクタリスティックへまとめて書き込み、分割送信を避ける（タイムアウトが短いため）。

## サンプリング周波数の設定 / Sampling Frequency Configuration
- TR45の計測周期（例: 1s, 5s, 10s, 30s, 60s）をアプリから設定可能。
- 推奨ワークフロー:
  1. 接続直後に現在値を読み取り、UIに反映。
  2. ユーザーが選択した値を`Write`で送信後、`Read`で反映を再確認（書き込み成功の確認を兼ねる）。
  3. サンプリング変更後はバッテリ消費に注意し、変更理由をログに残す。
- 落とし穴:
  - 高頻度設定時はデータバーストで通知ロスが起こりやすい。RSSIが弱い場合は周波数を下げるか、再送ロジックを入れる。
  - 設定反映には1〜2サイクルの遅延が発生することがあるため、即時反映を前提にしない。

## セキュリティOn/Off切り替え手順 / Toggling Security Mode
1. BLE接続後、セキュリティ設定キャラクタリスティックを`Read`して現在状態を確認。
2. ユーザーがOnを選択した場合、登録コード入力UIを表示し、入力完了後に`Write`。
3. On→Off 切替時は登録コード不要だが、既存のペアリング情報を削除するためにアプリ側でキャッシュクリア（Keychainに保存したコードも削除）。
4. 切替後は再接続シーケンスを走らせて状態を安定させる。

## 通知購読と再接続 / Notifications & Reconnect
- 温度計測値キャラクタリスティックは`Notify`を有効化。接続後すぐに`setNotifyValue(true)`を呼ぶ。
- iOSバックグラウンド動作時は接続が切れやすいので、RSSI監視と再スキャンのバックオフ戦略を持つ。
- 再接続時はセキュリティ状態を再確認し、必要なら登録コードを自動送信。

## デバッグとログ取得 / Debugging & Logging
- 接続/切断イベント、`didUpdateValueFor`の受信頻度、`didWriteValueFor`の成功・失敗を時間付きでログに残す。
- ペアリング失敗時の主要エラー:
  - `insufficient authentication` → 登録コード未送信または誤入力。
  - `connection interval too short` → サンプリング周波数高すぎ、または他デバイス干渉。
- 現場での一時的な切断は再スキャンで回復することが多い。10秒間隔で3回まで自動リトライすると安定。

## 運用チェックリスト / Operational Checklist
- [ ] 接続前にTR45の電池残量を確認（低電力だとセキュリティOn時に失敗しやすい）。
- [ ] 登録コードを事前に回収し、チーム共有リストに保管。
- [ ] 初回接続でサンプリング周波数とセキュリティ設定を読み取り、アプリに同期。
- [ ] 高頻度サンプリング時は電波状況を確認し、必要なら端末を近づける。
- [ ] 障害発生時はログをエクスポートして共有。

## 改善提案 / Improvement Ideas
- **登録コード管理の自動化**: QRコード読取でKeychainへ登録、チーム共有用に暗号化バックアップを作成。
- **設定プロファイル機能**: 現場ごとのサンプリング/セキュリティ設定プリセットを作り、接続時にワンタップ適用。
- **接続ヘルスモニタ**: RSSIと通知受信間隔から接続品質スコアを算出し、劣化時に自動で周波数を下げる。
- **テストシナリオ自動実行**: UIテストで「セキュリティOnで接続→登録コード入力→サンプリング変更→再接続」を自動化し、リグレッションを防ぐ。

## 引き継ぎメモ / Handoff Notes
- 過去の接続トラブルはほぼ登録コード未入力・誤入力が原因。まずここを確認。
- サンプリング周波数はデフォルトで5s。フィールドで高頻度が必要な場合のみ変更し、戻し忘れに注意。
- TR45ファームの古いロットはセキュリティOn時の再接続が不安定。再スキャンを挟むと成功率が上がる。

---
本ドキュメントは現場フィードバックに基づき更新予定です。追記すべき知見があれば`Docs/TR45BluetoothGuide.md`へ直接反映してください。
