# Meta Voice Developer Notes

## 背景
Meta Voice 機能は音声メモの書き起こしから各メタ情報を抽出します。2024年の改善でユーザー設定可能なキーワードと手動補正 UI を導入しましたが、その後の運用で以下の課題が顕在化しました。

- 「ドライバー」が検知できない／別項目に吸い込まれるケースがある。
- 「ゼッケン」が「石鹸」と誤認識された場合に Car/Driver が飛ばされ、残った語が Time 等へ流入する。
- 表への反映がずれた場合に Meta Voice 画面上で即時に修正しづらい。

## 判明した原因
1. **認識結果の母音長の揺れ**  
   Apple Speech の出力では長音記号が落ちて「ドライバ」「レーサ」等になることが多く、従来のキーワード一覧（長音ありのみ）ではヒットしませんでした。古いバージョンからアップデートした端末では `@AppStorage` に保存された過去のデフォルトがそのまま残るため、新しい候補語も適用されない状態でした。 【F:PitTemp/Core/Settings/SettingsStore.swift†L43-L88】【F:PitTemp/Core/Settings/SettingsStore.swift†L116-L141】

2. **誤認識語の未登録**  
   ゼッケン→石鹸と聞き間違えた音声は Car キーワードに掛からず、その後ろに続くドライバー名が Time など別フィールドに吸い込まれていました。誤認識の代表例をキーワードへ取り込むことで、後続値の切り出しが安定します。 【F:PitTemp/Core/Settings/SettingsStore.swift†L54-L67】

3. **値切り出し時の余計な除去処理**  
   旧実装では記号除去の過程で長音記号まで落としてしまい、後段の比較がさらに困難になるケースがありました。現在の `MetaValueRefiner` では時間／周回など必要最小限の整形にとどめ、その他フィールドは生テキストを保持する方針に変更しています。 【F:PitTemp/Views/MetaVoiceEditorView.swift†L620-L739】

## 実施した対策
- 設定ストアにドライバ長音無しバリアントや「石鹸」を含む新デフォルトを定義し、旧デフォルトと一致する保存値だけを自動マイグレーションするロジックを追加しました。これにより既存ユーザーも新しい候補語が即時反映されます。 【F:PitTemp/Core/Settings/SettingsStore.swift†L43-L88】【F:PitTemp/Core/Settings/SettingsStore.swift†L116-L141】
- Meta Voice エディタに「手動で微調整」セクションを追加し、各フィールドをその場で編集できるようにしました。抽出に失敗した項目だけを素早く補正できます。 【F:PitTemp/Views/MetaVoiceEditorView.swift†L472-L520】
- 抽出ロジックはヒットしたキーワード間の区間を値として扱う単純な手法ですが、`MetaValueRefiner` で時間・周回のみ個別整形し、それ以外は生の語を残すよう調整しました。これによりヒット済みのドライバー名などが二次加工で壊れることを防ぎます。 【F:PitTemp/Views/MetaVoiceEditorView.swift†L620-L739】

## 今後のチェックリスト
- 音声認識の結果ログ（`VoiceAttempt`）を定期的に見直し、誤認識の頻出パターンをキーワードにフィードバックする。
- キーワードをユーザーが編集した場合でも、新バージョンで追加された推奨語を案内できるよう、初回表示時に差分を提示する UI を検討する。
- 誤認識で Time/Lap に混入した文字列を検出するため、抽出結果に正規表現バリデーションを追加し、怪しい値は自動で無効化＋ユーザーに提示する。

